sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/m/Dialog","sap/ui/core/Fragment","sap/m/library","sap/m/MessageToast","sap/ui/core/routing/History","sap/ui/core/library","sap/uxap/ObjectPageSubSection"],function(e,t,n,o,a,s,g,i){"use strict";var r=o.ButtonType;var l=o.DialogType;var c=g.ValueState;var m=new sap.m.BusyDialog("oBusyDialog");let d;var p;var u;const v=async function(e,t,n,o){console.log(e);let a=e.bindContext(`/${t}(...)`);a.setParameter(o,JSON.stringify(n));await a.execute();let s=a.getBoundContext();let g=s.getObject();if(g){return g.value}else{return""}};return e.extend("panappbeta.ext.controller.Form",{override:{onInit:async function(){},onBeforeRendering:async function(){var e=this.base.getExtensionAPI().getModel();let t=this.base.getExtensionAPI();var n=window.location.href;var o=n.split("(");var a=o[1];var s=a.split("'");var g=s[1];let i="InsertData";let r=await v(e,i,g,"ID");console.log(r)},editFlow:{onBeforeDiscard:async function(e){let t=window.location.href;var n=t.split("(");var o=n[1];var a=o.split("'");let s=a[1];let g="flag";const i="discard";let r=e.context.getModel().bindContext(`/${g}(...)`);r.setParameter("ID",s);r.setParameter("case",i);await r.execute();const l=r.getBoundContext();var c=l.getValue();console.log(c);sap.ui.getCore().byId("panappbeta::tab1ObjectPage--fe::CustomSubSection::Attachment--uploadSet").mBindingInfos.items.binding.refresh()},onAfterSave:async function(e){let t=window.location.href;var n=t.split("(");var o=n[1];var s=o.split("'");let g=s[1];let i="flag";const p="saved";let u=e.context.getModel().bindContext(`/${i}(...)`);u.setParameter("ID",g);u.setParameter("case",p);await u.execute();const b=u.getBoundContext();var f=b.getValue();console.log(f);d=new sap.m.Dialog({title:"Confirm",type:l.Message,content:new sap.m.Text({text:"   Submit PAN Form For Approval  "}),beginButton:new sap.m.Button({type:r.Emphasized,text:"OK",press:async function(){m.open();const e=this.base.getExtensionAPI().getModel();let t="sendforapproval";let n=window.location.href;let o=window.location.origin;let s=window.location.search;let g=s.split("&");let i=g[0];let p=window.location.hash;p=p.replace("obj1-display","pan_approval-display");p=p.replace("panappbeta","panapproval");p=p.replace("tab1","PAN_Details_APR");var u=n.split("(");var b=u[1];var f=b.split("'");let A=await v(e,"getsync",f[1],"data");A=JSON.parse(A);if(A.length!=0){let n="https://btp-dev-0or0hi20.launchpad.cfapps.eu10.hana.ondemand.com/site?siteId=94a17d9a-05b5-425d-b51d-2cd74a2c2762#pan_approval-display?sap-ui-app-id-hint=saas_approuter_panapproval&/PAN_Details_APR('"+f[1]+"')";let s=o+"/site"+i+p;let g={url:s,PAN_Number:f[1],buttonclicked:"sendforApproval"};var w;try{console.log(e);let n=e.bindContext(`/${t}(...)`);n.setParameter("data",JSON.stringify(g));await n.execute();let o=n.getBoundContext();var w=o.getObject();d.close();d.destroy();m.close();if(w.value=="error"){window.alert("Sorry.. Please try again after sometime")}else{a.show("PANForm Submitted for Approval");var h=await sap.ushell.Container.getServiceAsync("Navigation");h.navigate({target:{semanticObject:"obj1",action:"display"}})}console.log(w)}catch(e){console.log(e);window.alert("Please check after few minutes...Try again after sometime in case of PAN is Not Submitted");d.close();d.destroy();m.close();var h=await sap.ushell.Container.getServiceAsync("Navigation");h.navigate({target:{semanticObject:"obj1",action:"display"}})}}else{if(!this.oErrorMessageDialog){this.oErrorMessageDialog=new sap.m.Dialog({type:l.Message,title:"Error",state:c.Error,content:new sap.m.Text({text:"Cannot Submit for approval When Approvers are Empty"}),beginButton:new sap.m.Button({type:r.Emphasized,text:"OK",press:function(){this.oErrorMessageDialog.close()}.bind(this)})})}d.close();d.destroy();m.close();this.oErrorMessageDialog.open()}}.bind(this)}),endButton:new sap.m.Button({text:"Close",press:async function(){m.open();const e=this.base.getExtensionAPI().getModel();let t="getuserinfo";let n=window.location.href;var o=n.split("(");var a=o[1];var s=a.split("'");let g=s[1];let i=await v(e,t,g,"ID");d.close();d.destroy();m.close()}.bind(this)})});d.open()},onBeforeEdit:async function(e){this.getView().getContent()[0].getSections()[3].setVisible(true);this.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].getDependents()[1].mAggregations.headerToolbar.setVisible(true)},onBeforeSave:async function(e){var t=this.base.getView().mAggregations.content[0].mAggregations.sections[2].mAggregations._grid.mAggregations.content[0].mAggregations._grid.mAggregations.content[0].mAggregations.content.mAggregations.items[1].mAggregations.items;var n=this.base.getView().mAggregations.content[0].mAggregations.sections[2].mAggregations._grid.mAggregations.content[0].mAggregations._grid.mAggregations.content[0].mAggregations.content.mAggregations.items[1].mBindingInfos.items.binding.oCache.aElements.$byPredicate;var o=this.base.getView().mAggregations.content[0].mAggregations.sections[2].mAggregations._grid.mAggregations.content[0].mAggregations._grid.mAggregations.content[0].mAggregations.content.mAggregations.items[1].mBindingInfos.items.binding.oCache.aElements.$byPredicate;var a=Object.values(o);for(var s=0;s<a.length;s++){var g=false;for(var i=0;i<t.length;i++){var r=t[i].mProperties.url;var l=/ID=([a-f\d-]+)/i;var c=r.match(l);if(a[s].ID===c[1]){g=true;break}}if(!g){this.base.getView().mAggregations.content[0].mAggregations.sections[2].mAggregations._grid.mAggregations.content[0].mAggregations._grid.mAggregations.content[0].mAggregations.content.mAggregations.items[1].mBindingInfos.items.binding.aContexts[s].delete()}}}},routing:{onBeforeBinding:async function(e){try{m.open();const l=this.base.getExtensionAPI().getModel();const c=this;let d=this.base.getExtensionAPI();var t=window.location.href;var n=t.split("(");var o=n[1];var a=o.split("'");var s=a[1];let b="InsertData";let f={some:"data"};let A=await v(l,b,s,"ID");console.log(A);console.log(A);var g="getData";var r=this.base.getAppComponent().getManifestObject()._oBaseUri._string;let w=r+`odata/v4/catalog/tab1?$filter=(PAN_Number%20eq%20%27${a[1]}%27)&$expand=tab1toWORKFLOW_HISTORY`;await $.ajax({url:w,success:function(e){console.log(e);h(e)},error:function(e,t,n){console.error(n)}});function h(e){var t;if(e.length){t=e}else if(e?.value){t=e.value[0]?.tab1toWORKFLOW_HISTORY}else{t=[]}var n=[];t.forEach(e=>{n.push({Result:e.Result,level:e.level,Notification_Status:e.Notification_Status,Title:e.Title,Employee_ID:e.Employee_ID,Employee_Name:e.Employee_Name,"Begin_Date/_Time":e.Begin_DateAND_Time,"End_Date/_Time":e.End_DateAND_Time,Days_Taken:e.Days_Taken,Status:e.Result,"By User":e.Approved_by})});c.base.getView().getContent()[0].getSections()[4].setBusy(true);let o=c.base.getView().getContent()[0].getSections()[4];let a=n.sort((e,t)=>{if(e.level>t.level){return 1}else if(e.level<t.level){return-1}else{return 0}});let s=[];let g=[];let r;let l;let d=a.length-1;a.forEach((e,t)=>{r=e.level;if(l!=undefined){if(r!==l){s.push(g);g=[]}}g.push(e);l=e.level;if(t==d){s.push(g)}});o.destroySubSections();o.addSubSection(new i({}));let u=o.getSubSections();let b=u[u.length-1];try{b.addBlock(new sap.m.ScrollContainer({horizontal:true,vertical:true,visible:true,height:"400px"}))}catch(e){}let f=b.getBlocks()[0];f.addContent(new sap.m.HBox({width:"100%",alignItems:"End",alignContent:"End"}));let A=f.getContent();let w=A[A.length-1];w.addItem(new sap.m.HBox({width:"90%"}));w.addItem(new sap.m.Button({text:"Refresh",press:async function(e){console.log(e);let t="updatee";let n=e.getSource().getModel();console.log();var o=window.location.href;var a=o.split("(");var s=a[1];var g=s.split("'");var i=g[1];let r=await v(n,t,i,"ID");r=JSON.parse(r);this.getParent().getParent().getParent().getParent().getParent().destroySubSections();h(r)}}));w.addItem(new sap.m.HBox({width:"1%"}));w.addItem(new sap.m.Button({text:"Comment History",press:async function(e){function t(){var e=Math.floor(Math.random()*1e6);var t=(new Date).getTime();var n=t+"-"+e;return n}if(!p){p=new sap.m.Dialog({title:"Approval Comments",endButton:new sap.m.Button({text:"Close",press:async function(){p.close()},layoutData:new sap.m.FlexItemData({growFactor:5,alignSelf:"End"})})})}p.addContent(new sap.m.VBox({width:"60vw"}));let n="getcomments";let o=e.getSource().getModel();console.log();var a=window.location.href;var s=a.split("(");var g=s[1];var i=g.split("'");var r=i[1];let l=await v(o,n,r,"ID");l=JSON.parse(l);const c=[];const m=l[0];if(m==undefined){p.getContent()[0].destroyItems();var d=new sap.suite.ui.commons.TimelineItem({text:"No Comments Found"});p.getContent()[0].addItem(d)}else{l.forEach(e=>{const t=e.createdAt;const n=e.createdBy;const o=e.modifiedAt;const a=e.modifiedBy;const s=e.idd;const g=e.PAN_Number;const i=e.user;const r=e.Comments;const l=e.status;c.push({firsname:i,lname:l,comment:r,dateTime:t})});p.getContent()[0].destroyItems();for(let e=0;e<c.length;e++){var d=new sap.suite.ui.commons.TimelineItem({id:`${"item"+t()}`,dateTime:`${c[e].dateTime}`,title:`${c[e].lname}`,userNameClickable:false,userNameClicked:"onUserNameClick",select:"onPressItems",userPicture:"Photo",text:`${c[e].comment}`,userName:`${c[e].firsname}`});p.mAggregations.content[0].addItem(d)}}p.open()}}));let C=0;s.forEach(e=>{f.addContent(new i({}));let t=f.getContent();let n=t[t.length-1];n.addBlock(new sap.m.VBox(`Box-${e[0].level}`));let o=n.getBlocks()[0];o.addItem(new sap.m.HBox({alignItems:"Center"}));let a=o.getItems()[0];a.addItem(new sap.m.Label({text:`Level ${e[0].level}`,design:"Bold"}));a.addItem(new sap.m.HBox({width:"40%"}));a.addItem(new sap.m.Label({text:`Notification: `}));if(c.getView().getContent()[0].getHeaderTitle().mAggregations._actionsToolbar.getContent()[4].mProperties.visible==true){a.addItem(new sap.m.Switch({enabled:!c.getView().getContent()[0].getHeaderTitle().mAggregations._actionsToolbar.getContent()[4].mProperties.visible,state:e[0].Notification_Status==="true",type:"AcceptReject",change:async function(e){console.log(e);m.open();let t=e.getSource().getParent().getItems()[0].mProperties.text;let n=t.split(" ");let o=n[1];let a="switch_control";let s=e.getSource().getModel();console.log();var g=window.location.href;var i=g.split("(");var r=i[1];var l=r.split("'");var c=l[1];var d={level:o,PAN_Number:c};let p=await v(s,a,d,"ID");console.log(p);m.close()}}))}else{if(!e[0].Result){a.addItem(new sap.m.Switch({enabled:true,state:e[0].Notification_Status==="true",type:"AcceptReject",change:async function(e){m.open();console.log(e);console.log(e);let t=e.getSource().getParent().getItems()[0].mProperties.text;let n=t.split(" ");let o=n[1];let a="switch_control";let s=e.getSource().getModel();console.log();var g=window.location.href;var i=g.split("(");var r=i[1];var l=r.split("'");var c=l[1];var d={level:o,PAN_Number:c};let p=await v(s,a,d,"ID");console.log(p);m.close()}}))}else{a.addItem(new sap.m.Switch({enabled:false,state:e[0].Notification_Status==="true",type:"AcceptReject",change:async function(e){m.open();console.log(e);console.log(e);let t=e.getSource().getParent().getItems()[0].mProperties.text;let n=t.split(" ");let o=n[1];let a="switch_control";let s=e.getSource().getModel();console.log();var g=window.location.href;var i=g.split("(");var r=i[1];var l=r.split("'");var c=l[1];var d={level:o,PAN_Number:c};let p=await v(s,a,d,"ID");console.log(p);m.close()}}))}}o.addItem(new sap.m.Table({visible:true}));let s=o.getItems()[1];let g=Object.keys(e[0]);g=g.slice(3);let r=[];g.forEach(e=>{if(!r.includes(e)){var t=new sap.m.Column({header:new sap.m.Label({text:e.replace(/_/g," ")}),width:"200px"});s.addColumn(t);r.push(e)}});e.forEach(e=>{let t=[];let n;let o=Object.values(e);o=o.slice(3);let a;o.forEach(e=>{a=new sap.m.Text({text:e});t.push(a)});n=new sap.m.ColumnListItem({cells:t});s.addItem(n)});C=C+1});c.base.getView().getContent()[0].getSections()[4].setBusy(false)};let C=await v(l,g,s,"ID");u=C;;if(C==="Approved"||C==="Rejected"||C==="Pending for Approval"){c.getView().getContent()[0].getSections()[3].setVisible(false);this.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].getDependents()[1].mAggregations.headerToolbar.setVisible(false);c.getView().getContent()[0].setShowEditHeaderButton(false);c.getView().getContent()[0].getHeaderTitle().mAggregations._actionsToolbar.getContent()[4].setEnabled(false);c.getView().getContent()[0].getHeaderTitle().mAggregations._actionsToolbar.getContent()[4].setVisible(false)}else{if(this.getView().getContent()[0].getHeaderTitle().mAggregations._actionsToolbar.getContent()[4].mProperties.visible===true){c.getView().getContent()[0].getSections()[3].setVisible(false);this.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].getDependents()[1].mAggregations.headerToolbar.setVisible(false);c.getView().getContent()[0].setShowEditHeaderButton(true);c.getView().getContent()[0].getHeaderTitle().mAggregations._actionsToolbar.getContent()[4].setEnabled(true);c.getView().getContent()[0].getHeaderTitle().mAggregations._actionsToolbar.getContent()[4].setVisible(true)}}let _=sap.ui.getCore().byId("panappbeta::tab1ObjectPage--fe::FacetSubSection::VendorData").mAggregations._grid.mAggregations.content[0].getContent().getContent().mAggregations._content.getRows().length;for(let S=0;S<_;S++){sap.ui.getCore().byId("panappbeta::tab1ObjectPage--fe::FacetSubSection::VendorData").mAggregations._grid.mAggregations.content[0].getContent().getContent().mAggregations._content.getRows()[S].getCells()[1].removeStyleClass("css1");sap.ui.getCore().byId("panappbeta::tab1ObjectPage--fe::FacetSubSection::VendorData").mAggregations._grid.mAggregations.content[0].getContent().getContent().mAggregations._content.getRows()[S].getCells()[5].removeStyleClass("css1");sap.ui.getCore().byId("panappbeta::tab1ObjectPage--fe::FacetSubSection::VendorData").mAggregations._grid.mAggregations.content[0].getContent().getContent().mAggregations._content.getRows()[S].getCells()[1].addStyleClass("css1");sap.ui.getCore().byId("panappbeta::tab1ObjectPage--fe::FacetSubSection::VendorData").mAggregations._grid.mAggregations.content[0].getContent().getContent().mAggregations._content.getRows()[S].getCells()[5].addStyleClass("css1")}}catch(y){console.log(y)}finally{m.close()}},onAfterBinding:function(e){var t=this.getView().getContent()[0].attachSectionChange(function(e){var t=e.getSource().mAggregations.sections[2].mAggregations._grid.mAggregations.content[0].mAggregations._grid.mAggregations.content[0].mAggregations.content.mAggregations.items[1].getItems();var n=e.getSource().mAggregations.headerTitle.mAggregations._actionsToolbar.getContent()[4].mProperties.visible;if(n==true||(u==="Pending for Approval"||u==="Approved"||u==="Rejected")){e.getSource().mAggregations.sections[2].mAggregations._grid.mAggregations.content[0].mAggregations._grid.mAggregations.content[0].mAggregations.content.getItems()[1].setUploadEnabled(false);for(let e=0;e<t.length;e++){t[e].setVisibleRemove(false);t[e].setEnabledRemove(false)}}else{e.getSource().mAggregations.sections[2].mAggregations._grid.mAggregations.content[0].mAggregations._grid.mAggregations.content[0].mAggregations.content.getItems()[1].setUploadEnabled(true);for(let e=0;e<t.length;e++){t[e].setVisibleRemove(true);t[e].setEnabledRemove(true)}}});var n=this.getView().getContent()[0].getHeaderTitle().mAggregations._actionsToolbar.getContent()[4].mProperties.visible;let o=this.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].getItems();if(!n){this.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].setUploadEnabled(true);for(let e=0;e<o.length;e++){this.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].getDependents()[1].mAggregations.headerToolbar.setVisible(true);o[e].setVisibleRemove(true);o[e].setEnabledRemove(true)}}else{this.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].setUploadEnabled(false);for(let e=0;e<o.length;e++){this.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].getDependents()[1].mAggregations.headerToolbar.setVisible(false);o[e].setVisibleRemove(false);o[e].setEnabledRemove(false)}}var a=e.oBinding.sPath;const s=/PAN_Number='([^']+)'/;const g=a.match(s);let i=window.location.href;var r=i.split("(");var l=r[1];var c=l.split("'");const m=c[1];var d=this.base.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].mBindingInfos.items.binding;d.filter(new sap.ui.model.Filter({path:"PAN_Number",operator:sap.ui.model.FilterOperator.EQ,value1:m}))}}}})});